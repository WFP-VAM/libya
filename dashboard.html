<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>Food Security Information - Libya 2018</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="css/main.css">
</head>

<body>

  <div id='map'>
  </div>

  <div class='map-overlay' id='legend'><strong>
      <legend>Food Insecure Population</legend>
    </strong></div>

  <div class='map-overlay' id='features'> </div>

  <div class='map-overlay' id='selection'>
    <strong>
      <legend>Displacement Status</legend>
    </strong>
    <form>
      <input type="radio" name="disp_status" value="All" autocomplete="off" checked> All<br>
      <input type="radio" name="disp_status" autocomplete="off" value="IDP"> IDPs<br>
      <input type="radio" name="disp_status" autocomplete="off" value="Returnee"> Returnees<br>
      <input type="radio" name="disp_status" autocomplete="off" value="NonDisplaced"> Non-Displaced
    </form>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoicGFzcXVpZXJqYiIsImEiOiJjaml1NjRkcmsxbnB2M3Btc3lzc2UwMmk4In0.WXzslqx4xB4fWBeBRU0AGw';

    if (!mapboxgl.supported()) {
        alert('Your browser does not support this Web Map - please try with a recent version of Firefox, Chrome or Safari');
    }

    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/pasquierjb/cjl2dra7b8re72slkbn8qefmj',
      center: [18.661, 27.356],
      zoom: 5,
      maxZoom: 8,
      minZoom: 4
    });

    var clicked = "All";
    var cached_json;
    $.getJSON(`data/MSNA_Mantikas_${clicked}.json`, function(data) {
      change_colors(data);
      cached_json = data;
    });

    var cached_pop_json;
    $.getJSON(`data/Population_Libya.json`, function(data) {
      cached_pop_json = data;
    });


    var layers = ['0-5%', '5-10%', '10-25%', '25-40%', '40-60%', '60-80%', '80-100%'];
    var colors = ['#FFEDA0', '#FED976', '#FEB24C', '#FD8D3C', '#FC4E2A', '#E31A1C', '#BD0026'];
    var thresholds = [0, 0.05, 0.10, 0.25, 0.40, 0.60, 0.80, 1]
    var expression = ['match', ['get', 'ADM2_Manti']];

    function change_colors(data) {
      var Mantikas = Object.keys(data);
      for (var i = 0; i < Mantikas.length; i++) {
        for (var j = 0; j < colors.length; j++) {
          if (data[Mantikas[i]]["Food_Insecure"] >= thresholds[j] && data[Mantikas[i]]["Food_Insecure"] < thresholds[j + 1]) {
            expression.push(Mantikas[i], colors[j])
          }
        }
      }
      expression.push('#D3D3D3'); // No data color
    }

    map.on('load', function() {

      map.addLayer({
        "id": "ocha_mantika",
        "type": "fill",
        "source": {
          type: 'vector',
          url: 'mapbox://pasquierjb.5suoc7hh'
        },
        "source-layer": "Mantika-169g1n",
        "paint": {
          'fill-color': '#EED322',
          'fill-opacity': 0.75
        }
      }, 'building');

      map.addLayer({
        "id": "ocha_mantika_borders",
        "type": "line",
        "source": {
          type: 'vector',
          url: 'mapbox://pasquierjb.5suoc7hh'
        },
        "source-layer": "Mantika-169g1n",
        "paint": {
          "line-color": "#888",
          "line-width": 0.5
        }
      }, 'waterway-label');

      map.setPaintProperty('ocha_mantika', 'fill-color', expression);
    });

    for (i = 0; i < layers.length; i++) {
      var layer = layers[i];
      var color = colors[i];
      var item = document.createElement('div');
      var key = document.createElement('span');
      key.className = 'legend-key';
      key.style.backgroundColor = color;

      var value = document.createElement('span');
      value.innerHTML = layer;
      item.appendChild(key);
      item.appendChild(value);
      legend.appendChild(item);
    }


    window.onload = function() {
      var radios = document.forms[0].elements["disp_status"];
      for (var i = [0]; i < radios.length; i++)
        radios[i].onclick = radioClicked;
    }

    function radioClicked() {
      clicked = this.value;
      $.getJSON(`data/MSNA_Mantikas_${clicked}.json`, function(data) {
        expression = ['match', ['get', 'ADM2_Manti']];
        change_colors(data);
        map.setPaintProperty('ocha_mantika', 'fill-color', expression);
        cached_json = data;
      })
    }

    function getfoodsecinfo(data, pop_data, Mantika) {
      var region = Mantika;
      console.log(pop_data);
      console.log(clicked);
      console.log(pop_data[clicked]);
      if (typeof data[region] !== 'undefined') {
        var HH_status = data[region]["displacement_status"];
        var HH_population = numberWithCommas(pop_data[clicked][region]);
        var food_insecure = (data[region]["Food_Insecure"] * 100).toFixed(0) + "%";
        var food_insecure_mar = (data[region]["Moderately_food_insecure"] * 100).toFixed(0) + "%";
        var food_insecure_sev = (data[region]["Severely_food_insecure"] * 100).toFixed(0) + "%";
        var borderline_fcs = (data[region]["FCG_Moderately_food_insecure"] * 100).toFixed(0) + "%";
        var poor_fcs = (data[region]["FCG_Severely_food_insecure"] * 100).toFixed(0) + "%";
        var bad_coping = ((data[region]["LCOP_Moderately_food_insecure"] + data[region]["LCOP_Severely_food_insecure"]) * 100).toFixed(0) + "%";
        var bad_share_foodexp = ((data[region]["SEF_Marginally_food_secure"] + data[region]["SEF_Moderately_food_insecure"]) * 100).toFixed(0) + "%";

        document.getElementById('features').innerHTML = '<h2><strong>' +
          region + ': ' + HH_status + '</h2></strong>' +
          '<br/>' +
          '<p><strong>' + HH_status + ' Population: ' + HH_population + ' people</strong></p>' +
          '<br/>' +
          '<p><strong>' + food_insecure + ' are Food Insecure</strong></p>' +
          '<br/>' +
          '<p>' + food_insecure_mar + ' are marginally Food Insecure</p>' +
          '<p>' + food_insecure_sev + ' are severly Food Insecure</p>' +
          '<br/>' +
          '<p>' + poor_fcs + ' have a poor Food Consumption</p>' +
          '<p>' + borderline_fcs + ' have a borderline Food Consumption</p>' +
          '<br/>' +
          '<p>' + bad_coping + ' use stress or emergency Coping Strategies</p>' +
          '<p>' + bad_share_foodexp + ' spend more than 65% of their Expenses on Food</p>';
      } else {
        document.getElementById('features').innerHTML = '<h2><strong>' + region + ': ' + 'No Food Security data </h2></strong>'
      }
    }

    map.on('mousemove', function(e) {
      var features = map.queryRenderedFeatures(e.point, {
        layers: ["ocha_mantika"]
      });
      if (features.length > 0) {
        var Mantika = features[0]["properties"]["ADM2_Manti"];
        getfoodsecinfo(cached_json, cached_pop_json, Mantika);
      } else {
        document.getElementById('features').innerHTML = ' <h2><strong>Hover your mouse over a Mantika to get the Food Security data</h2></strong>';
      }
    });

    const numberWithCommas = (x) => {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

  </script>

</body>

</html>
